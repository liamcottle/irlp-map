<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Interactive IRLP Map</title>

    <meta name="title" content="Interactive IRLP Map">
    <meta name="description" content="An interactive map of all IRLP nodes and their status.">
    <link rel="icon" type="image/png" href="https://irlp.liamcottle.net/icon.png"/>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://irlp.liamcottle.net">
    <meta property="og:title" content="Interactive IRLP Map">
    <meta property="og:description" content="An interactive map of all IRLP nodes and their status.">
    <meta property="og:image" content="https://irlp.liamcottle.net/icon-banner.png">
    <meta property="og:image:width" content="1600">
    <meta property="og:image:height" content="800">

    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <style>

        .icon-idle {
            background-color: #16a34a;
            border-radius: 25px;
            border: 1px solid white;
        }

        .icon-down {
            background-color: #dc2626;
            border-radius: 25px;
            border: 1px solid white;
        }

        .icon-linked {
            background-color: #2563eb;
            border-radius: 25px;
            border: 1px solid white;
        }

        .link {
            color: #2563eb;
        }

        .link:hover {
            text-decoration: underline;
        }

    </style>

</head>
<body class="h-full bg-gray-200">
<div v-cloak id="app" class="flex flex-col h-full w-full overflow-hidden">
    <div class="flex flex-col h-full">

        <!-- header -->
        <div class="flex bg-white p-2 border-gray-3400 border-b">
            <div class="my-auto mr-3">
                <img class="w-8 h-8" src="icon.png"/>
            </div>
            <div class="my-auto">
                <div class="font-bold">Interactive IRLP Map</div>
                <div class="text-sm">Created by <a class="link" target="_blank" href="https://liamcottle.com">Liam Cottle</a> <a class="link" target="_blank" href="https://www.qrz.com/db/zl2dev">ZL2DEV</a></div>
            </div>
            <div class="flex my-auto ml-auto mr-2 space-x-2">
                <a href="#" onclick="window.location.reload()">
                    <div class="hover:bg-gray-200 p-2 rounded-full">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                    </div>
                </a>
                <a href="#" onclick="alert('Click or hover a node to view its details.')">
                    <div class="hover:bg-gray-200 p-2 rounded-full">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                        </svg>
                    </div>
                </a>
            </div>
        </div>

        <!-- map -->
        <div id="map" style="width:100%;height:100%;"></div>

    </div>
</div>
<script>

    // create map positioned over AU and NZ
    var map = L.map('map').setView([
        -30,
        170,
    ], 3);

    var openStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | IRLP data from <a target="_blank" href="https://status.irlp.net">IRLP.net</a>',
    }).addTo(map);

    // create layer groups
    var nodesLayerGroup = new L.LayerGroup();
    var connectionsLayerGroup = new L.LayerGroup();

    // create icons
    var iconIdle = L.divIcon({ className: 'icon-idle'});
    var iconDown = L.divIcon({ className: 'icon-down'});
    var iconLinked = L.divIcon({ className: 'icon-linked'});

    // create legend
    var legend = L.control({position: 'bottomleft'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.style.backgroundColor = 'white';
        div.style.padding = '12px';
        div.innerHTML = `<div style="margin-bottom:6px;"><strong>Legend</strong></div>`
            + `<div style="display:flex"><div class="icon-idle" style="width:12px;height:12px;margin-right:4px;margin-top:auto;margin-bottom:auto;"></div> IDLE</div>`
            + `<div style="display:flex"><div class="icon-down" style="width:12px;height:12px;margin-right:4px;margin-top:auto;margin-bottom:auto;"></div> DOWN</div>`
            + `<div style="display:flex"><div class="icon-linked" style="width:12px;height:12px;margin-right:4px;margin-top:auto;margin-bottom:auto;"></div> LINKED</div>`;
        return div;
    };

    var baseLayers = {
        "OpenStreetMap": openStreetMap,
    };

    var overlays = {
        "Nodes": nodesLayerGroup,
        "Connections": connectionsLayerGroup,
    };

    // add layers to control ui
    L.control.layers(baseLayers, overlays).addTo(map);

    // add layers to map that should be enabled by default
    nodesLayerGroup.addTo(map);
    connectionsLayerGroup.addTo(map);
    legend.addTo(map);

    function isNumeric(str) {
        if (typeof str != "string") return false // we only process strings!
        return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
            !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
    }

    function isValidLatLng(lat, lng) {

        if(isNaN(lat) || isNaN(lng)){
            return false;
        }

        if(lat == 0 && lng == 0){
            return false;
        }

        if(lat < -90 || lat > 90){
            return false;
        }

        if(lng < -180 || lng > 180){
            return false;
        }

        return true;

    }

    function isNodeIdle(node) {
        return node.status === "IDLE";
    }

    function isNodeDown(node) {
        return node.status === ""
            || node.status === "DOWN";
    }

    function onNodesUpdated(nodes) {

        var nodeMarkers = {};

        // add nodes
        for(var node of nodes){

            var isLinked = isNumeric(node.status);
            var isReflector = node.callsign.startsWith("REF");
            var hasLocation = isValidLatLng(node.latitude, node.longitude);

            if(hasLocation){

                var icon = iconDown;

                if(isNodeIdle(node)){
                    icon = iconIdle;
                } else if(isLinked){
                    icon = iconLinked;
                } else if(isNodeDown(node)){
                    icon = iconDown;
                }

                // create tooltip
                var location = node.city + ", " + node.country;
                var tooltip = (isReflector ? `<b>Reflector ${node.id}</b>` : `<b>Node ${node.id}</b>`)
                    + `<br/>Status: ` + (isLinked ? `connected to ${node.status}` : node.status)
                    + (!isReflector ? `<br/>Call Sign: ${node.callsign}` : '')
                    + (!isReflector ? `<br/>Frequency: ${node.frequency_output_mhz} MHz` : '')
                    + (!isReflector ? `<br/>Offset: ${node.frequency_offset_khz} kHz` : '')
                    + (!isReflector ? `<br/>Tone: ${node.frequency_ctcss_hz} Hz` : '')
                    + (node.url ? `<br/>Website: <a target="_blank" href="${node.url}">${node.url}</a>` : '')
                    + `<br/>${location}`;

                // create node marker
                var marker = L.marker([node.latitude, node.longitude], {
                    icon: icon,
                }).bindTooltip(tooltip)
                    .bindPopup(tooltip)
                    .addTo(nodesLayerGroup)

                // add to cache
                nodeMarkers[node.id] = marker;

            }

        }

        // add node connections
        for(var node of nodes){

            var isLinked = isNumeric(node.status);

            if(isLinked){

                var currentNode = nodeMarkers[node.id];
                var connectedNode = nodeMarkers[node.status];

                if(currentNode && connectedNode){

                    L.polyline([
                        currentNode.getLatLng(),
                        connectedNode.getLatLng(),
                    ], {
                        color: '#2563eb',
                        opacity: 0.5,
                    }).addTo(connectionsLayerGroup);

                }
            }

        }

    }

    // fetch irlp nodes
    fetch('https://irlp.liamcottle.net/api/v1/nodes').then(async (response) => {
        var json = await response.json();
        onNodesUpdated(json.nodes);
    });

</script>
</body>
</html>